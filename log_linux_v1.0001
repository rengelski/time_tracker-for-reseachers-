#!/bin/bash
file_name='TimeLogs'
institution='Univerity of ___________'										
faculty='Faculty of Science'																			
division='Nano and Molecular Systems Research Unit'																		
name='Postdoctoral Researcher: __________________'																				
prof='Line Manager: _________________'	


signature="__________



"`date '+%Y/%m/%d'`"
_________________________________                                       _________________________________
Date and Signature of Postdoc Fellow                                    Date and Signature of Supervisor" 							

touch ~/"$file_name"_"$(date +"%Y_%m").log"

#Activity
echo "please select activity:
1.lectures
2.teaching
3.research
4.seminars|workshops|conferences
5.holiday"

read act
if [[ "$act" = "1" ]];then
	activity='lecture'
	echo "activity: "$activity""

elif [[ "$act" = "2" ]];then 
	activity='teaching'
	echo "activity: $activity"

elif [[ "$act" = "3" ]];then 
	activity='research'
	echo "activity: $activity"

elif [[ "$act" = "4" ]];then 
	activity='seminar|workshop|conference'
	echo "activity: $activity"

elif [[ "$act" = "5" ]];then 
	activity='HOLIDAY'
	echo "activity: $activity"

else 
	echo "you have chosen an incorrect option"
	activity='unidentified'
	echo "activity: $activity"
fi

################ VARIABLES ################
ll=$( tail -n 1 ~/"$file_name"_"$(date +"%Y_%m").log" )
rl="${ll%% *}"
#echo "rl: $rl"
################# HEADER #####################
if [[ "$ll" = "" ]]; then
	echo "$institution
$faculty
$division

$name
$prof
__________ 

`date +"%A"` Activity: $activity 
"log-in  : "`date '+%Y.%m.%d @ %H:%M:%S'`""">> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "First working day of the month: "`date '+%Y.%m.%d @ %H:%M:%S'`""

#"`date +"%A"` Activity: $activity 
#"log-in  : "`date '+%Y.%m.%d @ %H:%M:%S'`"">> "$file_name"_"$(date +"%Y_%m").log""

fi
ll=$( tail -n 1 ~/"$file_name"_"$(date +"%Y_%m").log" )
rl="${ll%% *}"
#echo "rl: "$rl""
if [[ "$rl" == "Date" ]];then
	sed -i "$(($(wc -l < ~/"$file_name"_"$(date +"%Y_%m").log")-9)),\$d" ~/"$file_name"_"$(date +"%Y_%m").log"
	ll=$( tail -n 1 ~/"$file_name"_"$(date +"%Y_%m").log" )
fi
if [[ "$rl" == "elapsed_time:" ]];then
	#sed -i "$(($(wc -l < "$file_name"_"$(date +"%Y_%m").log")-1)),\$d" "$file_name"_"$(date +"%Y_%m").log"
	ll=$(cat ~/"$file_name"_"$(date +"%Y_%m").log" | tail -3 | head -1 )
	#echo "$ll"
	#ll=$( tail -n 1 "$file_name"_"$(date +"%Y_%m").log" )
fi
rl="${ll%% *}"
#echo "rl: $rl"
sl=${ll#*log-in  : }
#echo "ll: $ll"
#echo "sl: $sl"
fulldate=${sl#*: }
#echo "full date: $fulldate"
idate=${fulldate%% *}
#echo "idate: $idate"
itime=${fulldate#*@ }
iday=${idate#*.*.}
#echo "iday: $iday"
fday=`date '+%d'`
#echo "today: "`date '+%d'`""
itime=$(date -d "$itime" "+%s")
ftime="`date '+%H:%M:%S'`"
ftime=$(date -d "$ftime" "+%s")	
dtime=$(($ftime-$itime))
hrs=$(($dtime/3600))
rhrs=$(($dtime%3600))
min=$(($rhrs/60))
sec=$(($rhrs%60))
n_hours="$hrs""hrs,""$min""mins,""$sec""secs"
#echo "itime: $itime"
#echo "ftime: $ftime"
echo "logged at date: "`date '+%Y.%m.%d @ %H:%M:%S'`""

ll=$( tail -n 1 "$file_name"_"$(date +"%Y_%m").log" )
rl="${ll%% *}"

#if [[ "$iday" = "$fday" ]];then
#	if [[ "$rl" == "elapsed_time:" ]];then  
#		sed -i "$(($(wc -l < "$file_name"_"$(date +"%Y_%m").log")-1)),\$d" "$file_name"_"$(date +"%Y_%m").log"
#	fi
#fi

if [[ "$iday" = "$fday" ]];then
	if [[ "$rl" == "elapsed_time:" ]];then  
		sed -i "$(($(wc -l < ~/"$file_name"_"$(date +"%Y_%m").log")-1)),\$d" ~/"$file_name"_"$(date +"%Y_%m").log"
	fi
	echo "log-out : "`date '+%Y.%m.%d @ %H:%M:%S'`"" >> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "elapsed_time: ""$n_hours" >> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "you have spent "$n_hours" on $activity"
else
	echo "
`date +"%A"` Activity: $activity 
"log-in  : "`date '+%Y.%m.%d @ %H:%M:%S'`""" >> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "log-out : "`date '+%Y.%m.%d @ %H:%M:%S'`"" >> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "elapsed_time: ""0hrs,0mins,0secs" >> ~/"$file_name"_"$(date +"%Y_%m").log"
	echo "you have spent 0hrs,0mins,0secs on $activity"
fi

# Today's date
today=$(date +%Y-%m-%d)

# Find the last weekday of the current month
last_date=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%Y-%m-%d)
while :; do
    dow=$(date -d "$last_date" +%u)  # 1=Mon, ..., 5=Fri, 6=Sat, 7=Sun
    if [[ $dow -ge 1 && $dow -le 5 ]]; then
        last_weekday=$last_date
        break
    fi
    last_date=$(date -I -d "$last_date -1 day")
done
#echo "last weekday of the month: $last_weekday"

# Check if today is the last weekday
if [[ "$today" == "$last_weekday" ]]; then
    echo "$signature" >> ~/""$file_name"_"$(date +"%Y_%m").log""
fi


